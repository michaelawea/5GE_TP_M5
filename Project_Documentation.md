# 双摆门控制系统完整技术文档

## 项目概述

本项目为施耐德电气M340 PLC的双摆门控制系统，使用Unity Pro开发，支持单门（行人）和双门（车辆）两种通行模式。系统集成了多种控制方式、完善的安全保护和智能化管理功能。

### 主要特性

- **双门板控制**：支持单门和双门工作模式
- **多种控制方式**：遥控器、键盘密码、对讲机三种控制方式
- **完善安全保护**：障碍物检测、过流保护、防夹保护
- **智能照明系统**：自动照明控制和警告信号
- **权限管理**：密码验证和锁定保护机制
- **系统诊断**：全面的故障检测和状态监控

## 系统架构

### 硬件配置

- **PLC主机**：Schneider Electric BMX P34 20102 V2.10
- **通信模块**：以太网NOE 100.2 (IP: 134.214.184.171)
- **开发软件**：Unity Pro
- **编程语言**：Structured Text (ST) + Function Block Diagram (FBD)

### 软件模块结构

```
双摆门控制系统
├── DFB_Gate_Control.st         # 单门控制逻辑模块
├── DFB_Safety_Check.st         # 安全检测模块
├── DFB_Keypad_Validation.st    # 密码验证模块
├── DFB_Command_Manager.st      # 命令管理模块
├── MAIN_Program.st             # 主控制程序
├── System_Configuration.st     # 系统配置和初始化
└── Project_Documentation.md    # 项目文档
```

## 详细模块说明

### 1. DFB_Gate_Control - 单门控制逻辑模块

**功能**：
- 控制单个门板的开关动作
- 管理门板状态机（关闭→开启中→开启→关闭中→关闭）
- 处理位置反馈和超时保护
- 支持紧急停止和安全保护

**主要输入参数**：
```st
Enable          : BOOL      // 使能信号
Open_Cmd        : BOOL      // 开门命令
Close_Cmd       : BOOL      // 关门命令
Emergency_Stop  : BOOL      // 紧急停止
Sensor_Open     : BOOL      // 全开位置传感器
Sensor_Close    : BOOL      // 全关位置传感器
Overcurrent     : BOOL      // 过流检测信号
```

**主要输出参数**：
```st
Motor_Open      : BOOL      // 开门电机输出
Motor_Close     : BOOL      // 关门电机输出
Status_Opening  : BOOL      // 正在开启状态
Status_Closing  : BOOL      // 正在关闭状态
Status_Open     : BOOL      // 全开状态
Status_Closed   : BOOL      // 全关状态
Error           : BOOL      // 故障指示
Error_Code      : INT       // 故障代码
```

**状态机逻辑**：
1. **状态0（关闭）**：门板处于关闭位置，等待开门命令
2. **状态1（开启中）**：电机驱动门板开启，检测开到位信号
3. **状态2（开启）**：门板完全开启，等待关门命令或自动关门
4. **状态3（关闭中）**：电机驱动门板关闭，检测关到位信号

### 2. DFB_Safety_Check - 安全检测模块

**功能**：
- 通道光栅传感器检测（障碍物检测）
- 门板过流检测（防夹保护）
- 市电故障检测
- 安全状态综合判断和联锁控制

**关键安全逻辑**：
```st
// 障碍物检测逻辑
Gate_Area_Occupied := NOT Passage_Sensor;
Obstacle_Timer(IN := Gate_Area_Occupied AND (Gate1_Moving OR Gate2_Moving), PT := Obstacle_Delay);

// 过流保护逻辑
Overcurrent_Timer_V1(IN := Overcurrent_V1 AND Gate1_Moving, PT := Overcurrent_Delay);
Reverse_Timer_V1(IN := Overcurrent_Gate1, PT := Reverse_Duration);
```

**安全联锁**：
- 检测到障碍物立即停止门板动作
- 过流检测时执行3秒反向动作后停止
- 电源故障时保持当前状态并报警

### 3. DFB_Keypad_Validation - 密码验证模块

**功能**：
- 4位数字密码输入验证
- 支持两个密码：1504（单门），2502（双门）
- 密码输入超时管理（10秒）
- 错误次数限制（3次错误锁定5分钟）
- 权限有效时间管理（30秒）

**密码逻辑**：
```st
// 密码计算
Input_Password := Input_Buffer[1] * 1000 + Input_Buffer[2] * 100 +
                  Input_Buffer[3] * 10 + Input_Buffer[4];

// 权限验证
IF Input_Password = Password_Single THEN
    Access_Type := 1;    // 单门权限
ELSIF Input_Password = Password_Dual THEN
    Access_Type := 2;    // 双门权限
```

**键盘接口**：需要在FBD中连接矩阵键盘扫描电路，支持0-9数字键、*清除键、#确认键。

### 4. DFB_Command_Manager - 命令管理模块

**功能**：
- 集中管理所有控制命令输入源
- 处理三种控制方式的优先级
- 命令冲突处理和安全检查
- 操作模式选择（单门/双门）

**优先级逻辑**（从高到低）：
1. **对讲机控制**：最高优先级，紧急访问
2. **遥控器/键盘控制**：日常使用
3. **自动控制**：定时开关等

**双击检测**：
```st
// 双击检测逻辑（快速切换到双门模式）
IF Remote_Single_Edge.Q OR Keypad_Single_Edge.Q THEN
    IF Double_Click_Timer.Q = FALSE AND Double_Click_Detected THEN
        Active_Command := 2;  // 切换到双门模式
    ELSE
        Active_Command := 1;  // 单门模式
        Double_Click_Detected := TRUE;
    END_IF;
END_IF;
```

### 5. MAIN_Program - 主控制程序

**功能**：
- 集成所有功能模块
- I/O地址映射和信号处理
- 照明和警告信号控制
- 系统状态管理和诊断

**主要I/O映射**：
```st
// 输入映射
Passage_Sensor      AT %I0.2.0  : BOOL;  // 通道光栅传感器
Gate1_Sensor_Open   AT %I0.2.2  : BOOL;  // 门板1全开传感器
Gate1_Sensor_Close  AT %I0.2.3  : BOOL;  // 门板1全关传感器
// ... 更多I/O映射

// 输出映射
Gate1_Motor_Open    AT %Q0.3.0  : BOOL;  // 门板1开启命令
Gate1_Motor_Close   AT %Q0.3.1  : BOOL;  // 门板1关闭命令
Warning_Light       AT %Q0.3.4  : BOOL;  // 警告信号灯
Area_Lighting       AT %Q0.3.5  : BOOL;  // 区域照明
```

## 控制方式详解

### 1. 遥控器控制
- **遥控器型号**：可配置多种品牌
- **控制距离**：建议30米以内
- **按键定义**：
  - 按键1：单门开关控制
  - 按键2：双门开关控制
  - 快速双击按键1：切换到双门模式

### 2. 键盘密码控制
- **密码设置**：
  - 单门密码：1504
  - 双门密码：2502
- **操作流程**：
  1. 输入4位密码
  2. 按#确认
  3. 在30秒有效期内控制门板
  4. 按*可清除输入
- **安全机制**：
  - 连续3次密码错误锁定5分钟
  - 输入超时10秒自动清除
  - 管理员可手动解锁

### 3. 对讲机控制
- **最高优先级**：可覆盖其他控制方式
- **访客流程**：
  1. 访客按对讲机呼叫按钮
  2. 住户通过对讲机应答
  3. 住户按开门按钮控制门板
- **控制按钮**：
  - 单门开启按钮
  - 双门开启按钮

## 安全保护机制

### 1. 障碍物检测
- **检测方式**：通道光栅传感器（红外光栅）
- **响应时间**：< 1秒
- **保护范围**：门板运动区域
- **动作逻辑**：
  - 检测到障碍物立即停止门板动作
  - 障碍物清除后可继续操作
  - 持续检测确保安全

### 2. 防夹保护
- **检测方式**：电机过流检测
- **响应时间**：< 500ms
- **保护动作**：
  1. 检测到过流立即停止当前动作
  2. 执行3秒反向动作释放夹持物
  3. 停止动作并等待下一次命令
- **灵敏度**：可调节，避免误触发

### 3. 电源故障保护
- **检测内容**：市电停电检测
- **保护动作**：
  - 立即停止所有门板动作
  - 保持当前门板位置
  - 激活故障报警信号
  - UPS供电时可紧急操作

### 4. 超时保护
- **开门超时**：30秒（可配置）
- **关门超时**：30秒（可配置）
- **保护动作**：
  - 超时后停止电机动作
  - 记录超时故障
  - 需要重新发送命令

## 照明和信号系统

### 1. 区域照明控制
- **自动开启条件**：
  - 检测到门板运动
  - 收到控制命令
  - 检测到障碍物
- **延时关闭**：活动停止后5分钟自动关闭
- **夜间模式**：18:00-06:00期间常亮（可配置）

### 2. 警告信号灯
- **闪烁模式**：门板运动时500ms周期闪烁
- **常亮模式**：系统故障时常亮
- **关闭模式**：系统正常且无活动时关闭

### 3. 状态指示
- **系统就绪**：绿灯常亮
- **门板运行**：黄灯闪烁
- **系统故障**：红灯常亮
- **权限验证**：蓝灯闪烁

## 故障诊断和维护

### 1. 故障代码表

| 错误代码 | 故障类型 | 描述 | 处理方法 |
|---------|---------|------|---------|
| 1001 | 门板超时 | 门板动作超时 | 检查机械阻力，重新校准 |
| 1002 | 安全故障 | 安全系统触发 | 检查传感器，清除障碍 |
| 1003 | 系统未使能 | 控制系统禁用 | 检查使能条件，重启系统 |
| 2001 | 障碍物检测 | 通道有障碍物 | 清除障碍物，检查传感器 |
| 2002 | 门板1过流 | 门板1电机过流 | 检查机械卡阻，调整参数 |
| 2003 | 门板2过流 | 门板2电机过流 | 检查机械卡阻，调整参数 |
| 2004 | 电源故障 | 主电源失效 | 检查电源供应，检查线路 |
| 3001 | 键盘锁定 | 密码错误锁定 | 等待解锁或管理员复位 |
| 3002 | 密码错误 | 输入密码无效 | 重新输入正确密码 |
| 3003 | 命令冲突 | 控制命令冲突 | 重新发送命令 |
| 3004 | 命令超时 | 控制命令超时 | 重新发送命令 |

### 2. 维护建议

**日常维护**（每月）：
- 清洁光栅传感器镜面
- 检查门板运动是否顺畅
- 测试所有控制方式功能
- 检查照明和信号灯工作状态

**定期维护**（每季度）：
- 检查电机电流是否正常
- 校准位置传感器
- 检查电缆连接是否牢固
- 更新操作和故障日志

**年度维护**：
- 更换易损件（如传感器、接触器）
- 全系统功能测试
- 参数优化和调整
- 备份系统配置和程序

### 3. 系统参数调整

**安全参数**：
```st
CFG_Max_Opening_Time    : TIME := T#30s;     // 最大开门时间
CFG_Max_Closing_Time    : TIME := T#30s;     // 最大关门时间
CFG_Obstacle_Delay      : TIME := T#1s;      // 障碍物检测延时
CFG_Overcurrent_Delay   : TIME := T#500ms;   // 过流检测延时
```

**控制参数**：
```st
CFG_Command_Timeout     : TIME := T#2s;      // 命令超时时间
CFG_Double_Click_Time   : TIME := T#1s;      // 双击检测时间
CFG_Auto_Close_Delay    : TIME := T#10s;     // 自动关门延时
```

## 部署和调试指南

### 1. 硬件安装
1. **PLC机柜安装**：
   - 选择干燥、通风、无振动位置
   - 预留维护空间（前后各30cm）
   - 接地电阻小于4Ω

2. **传感器安装**：
   - 位置传感器：距门板边缘5-10cm
   - 光栅传感器：高度1.2-1.5m，对射距离不超过门宽+0.5m
   - 过流传感器：安装在电机主电路中

3. **网络配置**：
   - 以太网IP：134.214.184.171
   - 子网掩码：255.255.255.0
   - 网关：134.214.184.1

### 2. 软件配置
1. **Unity Pro项目创建**：
   - 新建项目，选择BMX P34 20102型号
   - 导入所有DFB文件
   - 配置I/O地址映射

2. **参数配置**：
   - 根据现场情况调整安全参数
   - 设置密码和权限
   - 配置照明和信号参数

3. **程序下载**：
   - 编译检查无错误
   - 连接PLC并下载程序
   - 进入RUN模式

### 3. 系统调试
1. **I/O测试**：
   - 逐个测试输入信号
   - 验证输出动作正确性
   - 检查模拟量信号范围

2. **功能测试**：
   - 测试单门和双门模式
   - 验证三种控制方式
   - 测试所有安全保护功能

3. **性能优化**：
   - 调整开关门速度
   - 优化安全检测参数
   - 校准位置传感器

### 4. 验收测试
1. **安全测试**：
   - 障碍物检测响应时间
   - 防夹保护功能验证
   - 紧急停止功能测试

2. **功能测试**：
   - 控制方式切换测试
   - 密码验证功能测试
   - 照明和信号功能测试

3. **性能测试**：
   - 连续运行稳定性测试
   - 负载能力测试
   - 通信功能测试

## 技术支持和联系方式

**开发团队**：Claude Code Assistant
**技术支持**：请参考CLAUDE.md文档
**版本信息**：V1.0.0 (2025-09-23)
**兼容性**：Unity Pro V13.0及以上版本

**注意事项**：
1. 本系统仅供参考，实际部署需要专业工程师现场调试
2. 安全参数设置必须符合当地安全法规要求
3. 定期备份系统程序和配置参数
4. 发生故障时请及时联系技术支持

---

*此文档包含了双摆门控制系统的完整技术信息，包括系统设计、模块功能、安全机制、维护指南等内容。如需更详细的技术信息，请参考各个模块的源代码注释。*